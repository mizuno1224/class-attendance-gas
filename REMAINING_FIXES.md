# 残りの修正・改善一覧

このドキュメントは、出席管理アプリで未対応の修正・改善項目をまとめたものです。  
（1.1〜1.3 のバグ修正と 2.2 の重複防止は実施済み）

---

## 1. バグ・不具合

### 1.4 教科担任モーダルで「OK」を押しても反映されない

- **場所**: `js.html` の `applyModal()`
- **内容**: `currentTab === 'homeroom'` のときだけ `hrEdits` を更新しており、教科担任タブではモーダルで選んだ内容が反映されない。
- **対応案**:
  - 教科担任でも詳細入力（遅刻・早退・時限など）を使うなら、`currentTab === 'subject'` のときに `subjEdits` に同等の情報を入れる処理を追加する。
  - もしくは、教科担任ではモーダルを開かない／使わない設計にし、仕様を明文化する。

---

## 2. データ整合性・堅牢性

### 2.1 日付のタイムゾーン

- **場所**: `Utils.js` の `dateToKey_`、日付を扱う各所
- **内容**: `new Date(d)` に依存しているため、スプレッドシートのタイムゾーンや「日付のみ」の文字列でずれが起きる可能性がある。
- **対応案**: 日付は「YYYY-MM-DD」文字列で統一するルールを徹底する。GAS 側では `SpreadsheetApp.getActive().getSpreadsheetTimeZone()` を使ってフォーマットする。

### 2.3 ロック時間

- **場所**: `Utils.js` の `saveAttendanceCommon_`、`App_Master.js` の `saveDayConfiguration`
- **内容**: `LockService.getScriptLock()` で 10 秒。重い処理や通信遅延で 10 秒を超えると「Busy」になる。
- **対応案**: リトライ回数を設ける、または待機時間を 15 秒程度に延ばす。あわせて「保存中」表示でユーザーに待ってもらう前提にする。

---

## 3. UX・UI の改善

### 3.1 バージョン表示の一元管理 ✅ 実施済み

- **場所**: `index.html` の「出席管理 Ver29」
- **内容**: バージョンが HTML に直書きされている。
- **対応**: `App_Config.js` に `APP_VERSION = '29'` を定義し、`doGet` でテンプレートに渡して `index.html` で `<?= APP_VERSION ?>` 表示。

### 3.2 保存ボタンのフィードバック ✅ 実施済み

- **場所**: `js.html` の各 `withSuccessHandler` / `withFailureHandler`
- **対応**: `restoreSaveButton(btn, origText)` を共通で呼ぶように済み。

### 3.3 未保存でタブ切り替え時の確認 ✅ 実施済み

- **場所**: `js.html` のタブ切り替え時の `confirm`
- **対応**: 「保存してから移動」「破棄して移動」「キャンセル」の 3 択モーダルを実施済み。

### 3.4 モバイルでの操作性 ✅ 実施済み

- **場所**: `css.html` のテーブル・セル
- **対応**: セル `min-height: 36px`・`height: 36px`、`padding: 4px 2px`、固定列も 72px に統一。`.cell-status` / `.cell-btn` に `min-height` と `padding` を追加。

### 3.5 教科担任の「出席停止」選択肢 ✅ 実施済み

- **場所**: `index.html` のモーダル内 `.opt-btn`、クラス担任の集計表示
- **対応**: モーダルに「出席停止」ボタン追加。クラス担任の一覧・集計モーダルに「停」表示と出席停止の集計を追加。`calcSubjCounts` で出席停止を欠課扱いに追加。

---

## 4. パフォーマンス

### 4.1 初回 getInitialData の軽量化

- **場所**: `App_Config.js` の `getInitialData`、`getAllSheetData_`
- **内容**: 全シートを一度に読むため、シート数・行数が増えると遅くなる。
- **対応案**: 担任用の最小限のシート（`teacher_config`、`semesters` など）だけ先に読み、他は「クラス担任」「教科担任」「設定」タブを開いたときに必要なシートだけ読むように分割する。

### 4.2 localStorage キャッシュの鮮度

- **場所**: `js.html` の `localStorage.getItem('app_init_data')` および各キャッシュキー
- **内容**: キャッシュに有効期限がなく、他端末や別ユーザーの更新が反映されない。
- **対応案**: キャッシュに「取得時刻」を持たせ、一定時間（例: 5 分）経過したら無効にして再取得する。またはサーバー側で「最終更新」を返し、それと比較してキャッシュを破棄する。

### 4.3 カレンダー設定の一括保存

- **場所**: `App_Calendar.js` の `saveCalendarBulk`、`js.html` の `saveCalendarBulk`
- **内容**: 1 ヶ月分を一括送るため、行数が多いと GAS の実行時間制限に近づく可能性がある。
- **対応案**: 変更があった日付だけを送る「差分保存」API を用意する。または月をまたいで複数回に分けて保存するオプションを検討する。

---

## 5. 保守性・コード品質

### 5.1 マジックナンバーの定数化

- **場所**: 各ファイル（時限 1〜7、学期のデフォルト作成など）
- **内容**: 数値や文字列がコード中に直書きされている。
- **対応案**: `App_Config.js` に `const MAX_PERIOD = 7;`、`DEFAULT_SEMESTERS` などを定義し、参照をまとめる。

### 5.2 重複ロジックの共通化

- **場所**: 年度範囲でのフィルタ、`date` の YYYY-MM-DD 比較、`pad(n)` などが複数ファイルに散在
- **内容**: 同じロジックが複数箇所にあり、修正漏れや不整合の原因になりやすい。
- **対応案**: `Utils.js` に `isInYearRange(dateStr, yearStart, yearEnd)` や `padNum(n)` などをまとめ、バックエンド・フロントで共通化する。

### 5.3 エラーハンドリングの統一

- **場所**: `google.script.run` を呼んでいる箇所全体
- **内容**: `withFailureHandler` が未設定の箇所があると、失敗時に何も起きず原因が分かりにくい。
- **対応案**: すべての `google.script.run` に `withFailureHandler` を付け、少なくとも `showToast('エラー: ' + e.message, true)` とログを出すようにする。

### 5.4 科目名と ID の分離（将来拡張用）

- **場所**: `subjects` シート、表示ロジック
- **内容**: 現在は「科目名＝科目ID」で統一している。将来、表示名を分けたい場合の拡張がしづらい。
- **対応案**: `subjects` に `subjectName`（表示名）を追加し、表示時だけ名前を使う設計にしておく。必須ではなく、必要になった時点で対応してもよい。

---

## 6. アクセシビリティ

- **場所**: 出席表のセル（`js.html` / `css.html`）
- **内容**: セルの状態（出席・欠席など）が色と略字だけだと、色覚やスクリーンリーダーでは分かりにくい。
- **対応案**: `aria-label` で「出席」「欠席」「遅刻」などを明示する。または略字の横にツールチップでフル表記を出す。

---

## 7. ドキュメント・運用

### 7.1 MANUAL.md の拡充

- **場所**: `MANUAL.md`
- **内容**: Git / clasp の手順はあるが、アプリの「想定シート構成」「初期設定の流れ」「よくあるトラブル」がない。
- **対応案**: 「初回セットアップ（スプレッドシート側）」「シート一覧と役割」「バックアップとリストア」を追記する。

### 7.2 バックアップ手順

- **場所**: 運用・MANUAL
- **内容**: 出席データはスプレッドシートのみのため、誤削除や上書きのリスクがある。
- **対応案**: 定期的な「シートのコピー」や「エクスポート」手順を MANUAL に記載する。可能であれば GAS で日次バックアップ用のコピーを作るトリガーも検討する。

---

## 優先度の目安

| 優先度 | 項目 | 備考 |
|--------|------|------|
| **高** | 1.4（教科担任モーダル）、2.1（日付タイムゾーン）、5.3（エラーハンドリング） | **実施済み** |
| **中** | 2.3（ロック）、3.2（保存ボタン）、3.3（タブ切り替え）、4.2（キャッシュ鮮度） | **実施済み** |
| **低** | 3.1（バージョン）、3.4（モバイル）、5.1（マジックナンバー）、5.2（重複ロジック）、7.1・7.2（ドキュメント） | 未実施 |

---

*最終更新: 高・中優先度の項目を実装した時点*

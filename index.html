<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>出席管理アプリ</title>
  <?!= include('css'); ?>
</head>

<body>
  <header class="app-header">出席管理 Ver29</header>

  <div class="tab-row">
    <div class="tab-btn active" data-tab="homeroom">クラス担任</div>
    <div class="tab-btn" data-tab="subject">教科担任</div>
    <div class="tab-btn" data-tab="settings">設定</div>
  </div>

  <div class="container">
    <div id="tab-homeroom">
      <div class="card">
        <div class="row">
          <label style="font-size:12px; font-weight:bold;">学期:</label>
          <div id="hr-semester-btns" class="semester-btns"></div>
        </div>
        <div class="row" style="justify-content:space-between; margin-top:8px;">
          <div class="month-tabs" id="hr-month-tabs"></div>
          <button class="btn" id="hr-save-btn" disabled>保存</button>
        </div>
      </div>
      <div id="hr-table-wrapper" class="table-container">
        <div style="padding:20px; text-align:center;">読み込み中...</div>
      </div>
    </div>

    <div id="tab-subject" style="display:none;">
      <div class="card">
        <div class="row" style="align-items: center;">
          <select id="subj-grade"><option value="" disabled selected>学年</option></select>
          <select id="subj-class"><option value="" disabled selected>組</option></select>
          <div id="subj-subjects-container" class="subject-selector" style="margin-left:8px;"></div>
        </div>
        <div id="subj-remaining-info" style="font-size:12px; font-weight:bold; color:#059669; margin:4px 0;"></div>
        
        <div class="row" style="margin-top:8px;">
          <label style="font-size:12px; font-weight:bold;">学期:</label>
          <div id="subj-semester-btns" class="semester-btns"></div>
        </div>
        <div class="row" style="justify-content:space-between; margin-top:8px;">
          <div class="month-tabs" id="subj-month-tabs"></div>
          <button class="btn" id="subj-save-btn" disabled>保存</button>
        </div>
      </div>
      <div id="subj-table-wrapper" class="table-container"></div>
    </div>

    <div id="tab-settings" style="display:none;">
      <div class="card">
        <div class="master-toolbar">
          <label style="font-weight:bold; font-size:12px;">設定項目:</label>
          <select id="settings-mode-select" onchange="onSettingsModeChange()">
            <option value="calendar">カレンダー設定</option>
            <option value="students">生徒名簿</option>
            <option value="timetable">時間割(クラス別)</option>
            <option value="teacher_config">担当設定</option>
            <option value="subjects">科目マスタ</option>
            <option value="semesters">学期設定</option>
          </select>
        </div>

        <div id="settings-ui-calendar">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <input type="month" id="cal-setting-month" style="font-size:14px;">
            <button class="btn" id="cal-bulk-save-btn" disabled>一括保存</button>
          </div>
          <div style="font-size:10px; color:#666; margin-top:4px;">
            ※「有効時限」は "1,2,3,4" のように入力（空欄は全授業あり）
          </div>
        </div>

        <div id="settings-ui-master" style="display:none;">
          <div id="master-toolbar-generic" class="master-toolbar" style="justify-content:flex-end;">
            <button class="btn" style="background:#ef4444;" onclick="deleteMasterRows()">選択行を削除</button>
            <button class="btn" style="background:#10b981;" onclick="addMasterRow()">＋行追加</button>
            <button class="btn" id="master-save-btn" onclick="saveMaster()">保存</button>
          </div>
          <div id="master-toolbar-timetable" class="master-toolbar" style="display:none;">
             <select id="tt-class-select" onchange="renderTimetableGrid()"><option disabled selected>クラスを選択</option></select>
             <div style="flex:1;"></div>
             <button class="btn" id="master-tt-save-btn" onclick="saveMaster()">保存</button>
          </div>
        </div>
      </div>

      <div id="cal-settings-table-wrapper" class="table-container"></div>
      <div id="master-table-wrapper" class="table-container" style="display:none;"></div>
      <div id="timetable-grid-wrapper" style="display:none; overflow-x:auto; background:#fff; padding:4px;"></div>
    </div>
  </div>

  <div class="modal-overlay" id="modal-overlay">
    <div id="modal-content-input" class="modal" style="display:none;">
      <h3 id="modal-student-name" style="margin:0 0 8px 0;"></h3>
        <div id="modal-date-label" style="font-size:12px; color:#666; margin-bottom:12px;"></div>
        <div class="modal-opts">
          <button class="opt-btn" data-val="出席">出席</button>
          <button class="opt-btn" data-val="欠席">欠席(全)</button>
          <button class="opt-btn" data-val="遅刻">遅刻</button>
          <button class="opt-btn" data-val="早退">早退</button>
          <button class="opt-btn" data-val="忌引">忌引</button>
          <button class="opt-btn" data-val="感染症">感染症</button>
          <button class="opt-btn" data-val="公欠">公欠</button>
        </div>
        <div id="detail-periods" style="display:none;">
          <div style="font-size:12px; font-weight:bold; margin-bottom:4px;">欠課時限を選択</div>
          <div class="period-checks" id="modal-period-checks"></div>
        </div>
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;">備考</label>
          <input type="text" id="input-memo" style="width:100%; margin-top:4px;">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn" style="background:#ccc; color:#333;" onclick="closeModal()">キャンセル</button>
          <button class="btn" onclick="applyModal()">OK</button>
        </div>
    </div>

    <div id="modal-content-stats" class="modal" style="display:none;">
      <h3 id="modal-stats-title" style="margin:0 0 8px 0;"></h3>
      <div id="modal-stats-body" style="font-size:13px;"></div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
        <button class="btn" onclick="closeModal()">閉じる</button>
      </div>
    </div>
    
    <div id="modal-day-config" class="modal" style="display:none;">
       <h3 id="day-config-title" style="margin:0 0 8px 0;"></h3>
       <div style="margin-bottom:12px;">
         <label><input type="checkbox" id="dc-is-schoolday"> 登校日</label>
         <label style="margin-left:16px;"><input type="checkbox" id="dc-is-noclass"> 授業なし</label>
       </div>
       <div style="margin-bottom:12px;">
         <label style="font-size:12px; display:block; margin-bottom:4px;">行事・備考</label>
         <input type="text" id="dc-remark" style="width:100%;" placeholder="体育祭など">
       </div>
       <div style="margin-bottom:12px;">
         <label style="font-size:12px; display:block; margin-bottom:4px;">授業変更 (1限～7限)</label>
         <div id="dc-periods-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            </div>
       </div>
       <div style="display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn" style="background:#ccc; color:#333;" onclick="closeModal()">キャンセル</button>
          <button class="btn" onclick="saveDayConfig()">保存</button>
       </div>
    </div>

    <div id="modal-subject-history" class="modal" style="display:none;">
       <h3 id="sub-hist-title" style="margin:0 0 8px 0;">欠席履歴</h3>
       <div id="sub-hist-list" style="max-height:300px; overflow-y:auto; margin-bottom:16px;">
          読み込み中...
       </div>
       <div style="display:flex; justify-content:flex-end;">
          <button class="btn" onclick="closeModal()">閉じる</button>
       </div>
    </div>
  </div>

  <?!= include('js'); ?>
</body>
</html>